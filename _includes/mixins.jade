//- - function memoize = function(){
//-     var self = this, cache = {};
//-     return function( arg ){
//-       if(arg in cache) {
//-         console.log('Cache hit for '+arg);
//-         return cache[arg];
//-       } else {
//-         console.log('Cache miss for '+arg);
//-         return cache[arg] = self( arg );
//-       }
//-     }
//-   }

- function allPosts(path, section){
  - var r=childrenOf(path, section);
  - for(var key in section){
    - if (key !== '_data' && key !== '_contents') {
      - r=r.concat(allPosts(path.concat(key), section[key])) }}
  - return r }

- function href(path){
  - return '/' + path.join('/') }

- function subtree(path) {
  - var section = public;
  - for (var i = 0; i < path.length; i++) {
    - section = section[path[i]]
    - if (!section) return false }
  - return section }

- function childrenOf(path, section){
  - section = section || subtree(path)
  - var children = []
  - if (section) {
    - var allChildren = section['_data']
    - for (var slug in allChildren) {
      - if (allChildren[slug].index !== false) {
        - allChildren[slug].path = path.concat(slug)
        - children.push(allChildren[slug]) }}}
  - return children }

- function getPost(path){
  - var section = subtree(path.slice(0,-1))
  - var post = section && section._data && section._data[slug(path)] || {}
  - post.path = path
  - return post }

- function getCurrentPost(){
  //- path          strip URL  strip metadata path  
  //- ['index']           yes                   no
  //- [...,'index']       yes                  yes
  //- [...,'foo']          no                   no
  - var urlPath = current.path
  - if (urlPath[urlPath.length-1] == 'index') {
    - urlPath = urlPath.slice(0,-1) }
  - var metaDataPath = (current.path.length === 1) ? current.path : urlPath
  - var post = getPost(metaDataPath)
  - post.path = urlPath
  - return post }

- function slug(path) {return path[path.length-1] || '' }

- function slugToTitle(slug) { // helper for title()
  - return slug.replace(/-/g,' ').replace(/([^\W_]+[^\s-]*) */g,function(w){
    - return w.charAt(0).toUpperCase() + w.substr(1)
  - })}

- function title(post) { // find a title for {path}
  - return post.title || slugToTitle(slug(post.path)) }

- function active(path) { // is {path} an ancestor of {currentPost().path}?
  - var currentPath = getCurrentPost().path
  - return path.length <= currentPath.length && href(currentPath.slice(0, path.length)) == href(path) }

- function excerpt(path) {
  - var depth = current.path.length
  - var pathToRoot = Array(depth).join("../");
  - var content = partial(pathToRoot + path.join('/')) || ""
  - if(content.indexOf("<!-- more -->") == -1) return content
  - else return content.split("<!-- more -->")[0] }

- var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
- function format_date(d){
  - var D = new Date(d)
  - return months[D.getMonth()]+' '+D.getDate()+', '+D.getFullYear() }

- function sectionHasFile(section, file) { 
  - return section && section._contents && (section._contents.indexOf(file) !== -1) }

- function sourcePath(path) {
  - var section = subtree(path.slice(0,-1))
  - if (sectionHasFile(section, slug(path)+'.html')) {
    - return path
  - } else if (sectionHasFile(section[slug(path)], 'index.html')) {
    - return path.concat('index')
  - }
- }

- function editURL(path) {
  - return editBaseURL + sourcePath(path).join('/') + '.md' }

- function metadataEditURL(path) {
  - return editBaseURL + path.slice(0,-1).concat('_data.json').join('/') }

mixin link(post)
  a(href=href(post.path) title=title(post) class="post-link"+(active(post.path)?" active":""))
    if block
      block
    else
      = title(post)

mixin date_label(date)
  if date
    div.date(data-raw=date)= format_date(date)
    | 

mixin post_summary(post)
  .post-summary
    mixin link(post)
    mixin date_label(post.date)
    div.excerpt!= excerpt(post.path)

mixin nav(path)
  each post in childrenOf(path)
    mixin link(post)
